<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spaceburgers Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @media (min-width: 1024px) {
        .hero-bg::before {
          content: "";
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
          background: rgba(0, 0, 0, 0.5); /* Black overlay with opacity */
          z-index: 10;
        }
        .hero-bg {
          background-image: url("./static/background.png");
          background-size: cover;
          background-position: center right;
          position: relative;
        }
      }

      .gradient-btn {
        background-image: linear-gradient(to right, #f6d365 0%, #fda085 100%);
        position: relative;
        z-index: 10;
      }

      .gradient-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.15);
        z-index: -1;
        border-radius: inherit;
      }

      .gradient-recording {
        background-image: linear-gradient(to right, #ef5777 0%, #575fcf 100%);
      }

      .text-shadow {
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      @keyframes pulseAnimation {
        0%,
        100% {
          transform: scale(1);
          background-color: #4b5563;
        }
        50% {
          transform: scale(1.05);
          background-color: #374151;
        }
      }

      .pulse {
        animation: pulseAnimation 2s infinite;
      }

      /* Grid item size variations */
      .grid-span-2 {
        grid-column: span 2;
      }
      .grid-span-3 {
        grid-column: span 3;
      }
      .grid-row-2 {
        grid-row: span 2;
      }

      /* Highlight effect */
      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 8px 2px yellow;
        }
        50% {
          box-shadow: 0 0 16px 4px yellow;
        }
      }

      @keyframes sparklingGlow {
        0%,
        100% {
          box-shadow: 0 0 8px 2px #ffd700;
          border-color: #ffd700;
        }
        50% {
          box-shadow: 0 0 12px 3px #ffa500;
          border-color: #ffa500;
        }
      }

      .highlight {
        animation: sparklingGlow 2s infinite alternate;
        transform: scale(1.05);
        border: 2px solid #ffd700; /* Initial state color */
      }

      @media (min-width: 768px) {
        /* TailwindCSS md: breakpoint */
        .scrollable-bento-grid {
          max-height: 80vh; /* Adjust based on your design needs */
          overflow-y: auto; /* Enables vertical scrolling */
        }
      }
    </style>
  </head>
  <body class="bg-gray-800">
    <div class="min-h-screen flex flex-col md:flex-row hero-bg">
      <div class="md:w-1/2 p-10 flex flex-col justify-center relative z-20">
        <h3 class="text-xl text-white">
          You're hungry? We've got you covered!
        </h3>
        <h1 class="text-4xl font-bold text-white mt-2">Spaceburgers</h1>
        <hr class="my-4 border-gray-300" />
        <p class="text-white mb-6">
          Our lovely robot is looking forward to take your order.
        </p>
        <button id="actionBtn">üéôÔ∏è Record my order</button>
      </div>
      <!-- Background image for desktop is handled via CSS, with a shadow overlay -->
      <div class="md:w-1/2">
        <div
          class="container min-h-full mx-auto p-6 relative z-20 scrollable-bento-grid"
        >
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="bentoGrid">
            {% for item in items %}
            <div
              class="card bg-gradient-to-r from-gray-700 to-gray-900 rounded-lg overflow-hidden shadow-lg {{ item[-1] }}"
              id="item-{{ item[0] }}"
            >
              <img src="{{ item[4] }}" alt="{{ item[1] }}" class="w-full" />
              <div class="p-4">
                <h5 class="text-white text-xl leading-tight font-medium mb-2">
                  {{ item[1] }}
                </h5>
                <!-- Initially hidden description -->
                <p
                  class="text-white opacity-75 text-sm description"
                  style="display: none"
                >
                  {{ item[2] }}
                </p>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div
          class="fixed bottom-4 right-4 flex items-center p-2 bg-gradient-to-r from-f6d365 to-fda085 rounded-full shadow-lg cursor-pointer z-50 bg-slate-800 opacity-75"
          id="fabContainer"
        >
          <label class="relative inline-flex cursor-pointer items-center">
            <input id="menuToggleSwitch" type="checkbox" class="peer sr-only" />
            <label for="menuToggleSwitch" class="hidden"></label>
            <div class="peer-checked:bg-gradient-to-r peer-checked:from-yellow-400 peer-checked:via-orange-200 peer-checked:to-orange-500 bg-slate-800 peer h-6 w-11 rounded-full border after:absolute after:left-[2px] after:top-0.5 after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:ring-green-300"></div>
          </label>        
          <span class="ml-3 text-white font-medium" id="fabText"
            >Menu Preview</span
          >
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      let state = "idle"; // Possible states: idle, recording, sending
      let mediaRecorder;
      let chunks = [];
      let highlightedItems = [];

      var socket = io.connect(
        "http://" + document.domain + ":" + location.port
      );

      socket.on("connect", function () {
        console.log("Websocket connected!");
      });

      let clientUUID = null;
      socket.on("assign_uuid", function (data) {
        clientUUID = data.uuid;
        console.log("Assigned UUID:", clientUUID);
        // You can now use clientUUID to identify this client in future communications
      });

      socket.on("highlight", function (data) {
        console.log("Highlighting item:", data);
        const { typ, id } = data;
        const itemElement = document.getElementById(`item-${id}`);
        if (!itemElement) return;

        if (typ === "select") {
          if (!highlightedItems.includes(id)) {
            itemElement.classList.add("highlight");
            highlightedItems.push(id); // Add to highlighted items if not already present
          }
        } else if (typ === "deselect") {
          const index = highlightedItems.indexOf(id);
          if (index > -1) {
            itemElement.classList.remove("highlight");
            highlightedItems.splice(index, 1); // Remove from highlighted items
          }
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const toggleSwitch = document.getElementById("menuToggleSwitch");
        const menuContainer = document.querySelector(".scrollable-bento-grid");
        const fabText = document.getElementById("fabText");
        // Initialize menu visibility state: default to hidden
        localStorage.setItem("isMenuVisible", false);

        // Function to load and update menu visibility
        function updateMenuVisibility() {
          const isMenuVisible =
            localStorage.getItem("isMenuVisible") !== "false";
          menuContainer.style.display = isMenuVisible ? "block" : "none";
          toggleSwitch.checked = isMenuVisible;
          fabText.textContent = isMenuVisible
            ? "Close Menu"
            : "Open Menu";
        }

        // Initialize based on saved state
        updateMenuVisibility();

        // Toggle menu on click and save state
        toggleSwitch.addEventListener("change", () => {
          const isMenuVisible = toggleSwitch.checked;
          localStorage.setItem("isMenuVisible", isMenuVisible);
          updateMenuVisibility();
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const cards = document.querySelectorAll("#bentoGrid .card");

        cards.forEach((card) => {
          const img = card.querySelector("img");
          const titleDiv = card.querySelector("div.p-4");
          const description = card.querySelector("p.description");

          const contentHeight = img.offsetHeight + titleDiv.offsetHeight;
          if (description && contentHeight < card.offsetHeight) {
            // There is extra space, so show the description
            description.style.display = "block";
          }
        });
      });

      const actionBtn = document.querySelector("#actionBtn");
      updateButton();

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.onstart = () => {
          chunks = [];
          state = "recording";
          updateButton();
        };

        mediaRecorder.ondataavailable = async (e) => {
          if (e.data.size > 0) {
            chunks.push(e.data);

            // Debugging: Log the audio chunk data
            console.log("Data available", e.data.size, e.data.type, e.data);

            // Prepare and send the current audio chunk to the server
            const formData = new FormData();
            // formData.append("audio_chunk", e.data);
            formData.append(
              "audio_chunk",
              new Blob([...chunks, e.data], { type: "audio/webm" })
            );
            formData.append("uuid", clientUUID); // Assuming you've already obtained `clientUUID` from the server
            formData.append(
              "highlightedItems",
              JSON.stringify(highlightedItems)
            );
            await fetch("/stream-audio", {
              method: "POST",
              body: formData,
            });
          }

          chunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          state = "sending";
          updateButton();

          const blob = new Blob(chunks, { type: "audio/mp3" });
          const formData = new FormData();
          formData.append("file", blob, "recording.mp3");
          const uploadResult = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          if (uploadResult.ok) {
            const result = await uploadResult.json();
            window.location.href = "/order?recording_id=" + result.recording_id;
          }
        };

        actionBtn.addEventListener("click", () => {
          if (state === "idle") {
            mediaRecorder.start(500);
          } else if (state === "recording") {
            mediaRecorder.stop();
          }
        });
      });

      function updateButton() {
        if (state === "idle") {
          actionBtn.textContent = "üéôÔ∏è Record my order";
          actionBtn.className =
            "gradient-btn hover:bg-opacity-90 text-white font-bold py-4 px-8 rounded-full transition ease-in-out duration-150 text-shadow";
        } else if (state === "recording") {
          actionBtn.textContent = "Stop recording";
          actionBtn.className =
            "gradient-recording hover:bg-opacity-90 text-white font-bold py-4 px-8 rounded-full transition ease-in-out duration-150 text-shadow";
        } else if (state === "sending") {
          actionBtn.textContent = "Sending...";
          actionBtn.disabled = true;
          actionBtn.className =
            "bg-gray-500 text-white font-bold py-4 px-8 rounded-full pulse";
        }
      }
    </script>
  </body>
</html>
